CREATE SERVER quasar FOREIGN DATA WRAPPER quasar_fdw OPTIONS (server 'http://localhost:8080', path '/local/quasar');
CREATE FOREIGN TABLE zips(city varchar, pop integer, state char(2))
       SERVER quasar OPTIONS (table 'zips');
CREATE FOREIGN TABLE zipsloc(loc numeric[2]) SERVER quasar OPTIONS (table 'zips');
CREATE FOREIGN TABLE zipsjson(loc json, locb jsonb OPTIONS (map 'loc'))
       SERVER quasar OPTIONS (table 'zips');
CREATE FOREIGN TABLE nested(a varchar OPTIONS (map 'topObj.midObj.botObj.a'),
                            b varchar OPTIONS (map 'topObj.midObj.botObj.b'),
                            c varchar OPTIONS (map 'topObj.midObj.botObj.c'))
       SERVER quasar
       OPTIONS (table 'nested');
/* Select */
/* Basic selection with limit */
SELECT * FROM zips LIMIT 3;
   city    |  pop  | state 
-----------+-------+-------
 BARRE     |  4546 | MA
 AGAWAM    | 15338 | MA
 BLANDFORD |  1240 | MA
(3 rows)

/* Select less fields than exist */
SELECT city FROM zips LIMIT 1;
 city  
-------
 BARRE
(1 row)

/* Basic WHERE clause */
SELECT * FROM zips WHERE "state" = 'CO' LIMIT 2;
  city  |  pop  | state 
--------+-------+-------
 ARVADA | 12065 | CO
 ARVADA | 32980 | CO
(2 rows)

/* Nested selection */
SELECT * FROM nested LIMIT 1;
 a | b | c 
---+---+---
 m | n | o
(1 row)

/* less fields than in relation, with one in a WHERE clause */
SELECT city FROM zips WHERE "state" = 'CO' LIMIT 1;
  city  
--------
 ARVADA
(1 row)

SELECT city,pop FROM zips WHERE pop % 2 = 1 LIMIT 3;
     city     |  pop  
--------------+-------
 BELCHERTOWN  | 10579
 CUSHMAN      | 36963
 CHESTERFIELD |   177
(3 rows)

/* Test out array usage */
SELECT * FROM zipsloc LIMIT 2;
ERROR:  Array types not supported by quasar_fdw. Use json
/* Test out json usage */
SELECT loc->0 AS loc0, locb->1 AS loc1, locb FROM zipsjson LIMIT 2;
    loc0    |   loc1    |          locb           
------------+-----------+-------------------------
 -72.108354 | 42.409698 | [-72.108354, 42.409698]
 -72.622739 | 42.070206 | [-72.622739, 42.070206]
(2 rows)

/* Pushdown tests using EXPLAIN */
EXPLAIN SELECT * FROM zips;
                         QUERY PLAN                          
-------------------------------------------------------------
 Foreign Scan on zips  (cost=100.00..101.00 rows=1 width=48)
   Quasar query: SELECT city, pop, state FROM zips
(2 rows)

/* Pushdown some where clauses */
EXPLAIN SELECT city FROM zips WHERE "state" = 'CO';
                            QUERY PLAN                             
-------------------------------------------------------------------
 Foreign Scan on zips  (cost=100.00..101.00 rows=1 width=32)
   Filter: (state = 'CO'::bpchar)
   Quasar query: SELECT city, state FROM zips WHERE (state = 'CO')
(3 rows)

EXPLAIN SELECT * FROM zips WHERE "state" LIKE 'A%';
                                QUERY PLAN                                 
---------------------------------------------------------------------------
 Foreign Scan on zips  (cost=100.00..101.00 rows=1 width=48)
   Filter: (state ~~ 'A%'::text)
   Quasar query: SELECT city, pop, state FROM zips WHERE (state LIKE 'A%')
(3 rows)

EXPLAIN SELECT * FROM zips WHERE "city" !~~ 'B%';
                                  QUERY PLAN                                  
------------------------------------------------------------------------------
 Foreign Scan on zips  (cost=100.00..101.00 rows=1 width=48)
   Filter: ((city)::text !~~ 'B%'::text)
   Quasar query: SELECT city, pop, state FROM zips WHERE (city NOT LIKE 'B%')
(3 rows)

EXPLAIN SELECT * FROM zips WHERE pop > 1000 AND pop <= 10000;
                                       QUERY PLAN                                        
-----------------------------------------------------------------------------------------
 Foreign Scan on zips  (cost=100.00..101.00 rows=1 width=48)
   Filter: ((pop > 1000) AND (pop <= 10000))
   Quasar query: SELECT city, pop, state FROM zips WHERE (pop > 1000) AND (pop <= 10000)
(3 rows)

EXPLAIN SELECT * FROM zips WHERE pop % 2 = 1;
                               QUERY PLAN                                
-------------------------------------------------------------------------
 Foreign Scan on zips  (cost=100.00..101.00 rows=1 width=48)
   Filter: ((pop % 2) = 1)
   Quasar query: SELECT city, pop, state FROM zips WHERE ((pop % 2) = 1)
(3 rows)

